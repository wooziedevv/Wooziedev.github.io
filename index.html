<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="icon" href="https://r.resimlink.com/FrNusUEa.jpeg" type="image/png">
<style>
  /* --------------- Orijinal site temel stilleri (korunacak) --------------- */
  *{box-sizing:border-box}
  body{font-family:'Segoe UI', Tahoma, Verdana, sans-serif;background:#000;color:#fff;margin:0}
  header{position:fixed;top:0;width:100%;background:rgba(0,0,0,.85);padding:1rem 2rem;display:flex;justify-content:space-between;align-items:center;z-index:999}
  .logo{display:flex;align-items:center;gap:8px;cursor:pointer}
  nav a{color:#fff;text-decoration:none;margin-left:1rem}
  .hero{height:100vh;background:url('https://r.resimlink.com/eW-gkBi17DO.jpeg') center/cover no-repeat;display:flex;align-items:center;justify-content:center;margin-top:80px}
  .hero h1{font-size:3rem;background:rgba(0,0,0,.6);padding:1rem 2rem;border-radius:10px}
  main{max-width:1100px;margin:0 auto;padding:4rem 2rem;text-align:center}
  .about-content{position:relative;z-index:2;background:rgba(0,0,0,.6);padding:2rem;border-radius:10px;text-align:left}
  footer{text-align:center;padding:2rem;border-top:1px solid #333;font-size:.9rem}

  /* --------------- Auth row (orijinalin Ã¼stÃ¼ne ekleme) --------------- */
  #authRow{display:flex;gap:20px;justify-content:center;margin-top:20px}
  #registerBox,#loginBox{background:rgba(255,255,255,0.03);padding:12px;border-radius:8px;border:1px solid #222}
  #registerBox input,#loginBox input{display:block;padding:.5rem;margin:.3rem 0;width:220px;border-radius:6px;border:1px solid #333;background:transparent;color:#fff}
  #registerBox button,#loginBox button{padding:.5rem 1rem;margin-top:8px;border-radius:6px;border:none;background:#fff;color:#000;font-weight:700;cursor:pointer}
  #userBox{margin-top:20px}

  /* --------------- Sidebar --------------- */
  .hamburger{font-size:22px;cursor:pointer;margin-left:12px}
  .notif-bell{cursor:pointer;margin-right:12px;position:relative}
  .notif-count{position:absolute;top:-8px;right:-6px;background:#ff4d4d;color:#000;padding:2px 6px;border-radius:12px;font-weight:700;font-size:12px;display:none}

  .sidebar{
    position:fixed;right:-420px;top:0;width:420px;height:100vh;background:#090909;box-shadow:-8px 0 36px rgba(0,0,0,.6);
    transition:right .25s ease;z-index:1200;padding:16px;overflow:auto;
  }
  .sidebar.open{right:0}
  .sidebar .closeX{position:absolute;left:12px;top:12px;cursor:pointer;color:#fff}
  .sidebar h3{margin-top:0}
  .menu-item{display:block;padding:12px;border-radius:8px;margin:6px 0;background:transparent;color:#ddd;text-decoration:none;border:1px solid rgba(255,255,255,0.03);cursor:pointer}
  .menu-item:hover{background:#fff;color:#000}

  /* panels (SPA-style) */
  .panel{display:none;text-align:left;margin-top:12px}
  .panel.active{display:block}

  /* profile card */
  .profile-card{background:rgba(255,255,255,0.03);padding:12px;border-radius:8px}
  .profile-card img{width:96px;height:96px;border-radius:50%;object-fit:cover;border:2px solid #fff;display:block;margin-bottom:8px}

  /* chat area */
  #interactiveArea{display:none;margin-top:20px}
  .chat-layout{display:flex;gap:18px;justify-content:center}
  .chat-box{background:rgba(255,255,255,0.02);border:1px solid #222;padding:12px;border-radius:8px;width:48%}
  #globalChat,#dmBox{height:260px;overflow:auto;padding:8px;background:transparent}
  .msg{padding:6px;border-bottom:1px dashed rgba(255,255,255,.03);margin-bottom:6px}

  /* search results */
  #searchResults li{list-style:none;padding:8px;border-bottom:1px solid #222;cursor:pointer}

  /* admin modal */
  #adminModal{position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:1400}
  #adminModal .box{background:#111;padding:20px;border-radius:10px;max-width:420px;width:90%}

  /* small screens */
  @media(max-width:800px){
    .sidebar{width:100%;right:-100%}
    .chat-layout{flex-direction:column}
    .chat-box{width:100%}
    #registerBox,#loginBox input{width:100%}
  }
</style>
</head>
<body>

  <!-- HEADER (same as original) -->
  <header>
    <div style="display:flex;align-items:center">
      <div class="logo" onclick="location.hash='#home'">
  <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="NF Logo" style="height:40px;cursor:pointer;">
    <path d="M20 180 L20 30 L60 30 L120 130 L120 30 L160 30 L160 180 L120 180 L120 80 L60 180 Z" fill="#ffffff"/>
    <path d="M120 30 L190 30 L190 60 L160 60 L160 90 L190 90 L190 120 L160 120 L160 180 L120 180 Z" fill="#ffffff"/>
  </svg>
</div>
      
      <nav style="margin-left:12px">
        <a href="#home">Ana Sayfa</a>
        <a href="#about">HakkÄ±mÄ±zda</a>
        <a href="#contact">Ä°letiÅŸim</a>
      </nav>
    </div>

    <div style="display:flex;align-items:center">
      <div class="notif-bell" onclick="openPanelAndCloseSidebar('notifs')">ðŸ””<span id="notifCount" class="notif-count">0</span></div>
      <div class="hamburger" onclick="toggleSidebar()">â˜°</div>
    </div>
  </header>

  <!-- HERO (original) -->
  <section class="hero" id="home"><h1>NexuForge</h1></section>

  <main>
    <!-- ABOUT (original) -->
    <section id="about" class="about-section">
      <video autoplay muted loop playsinline>
        <source src="https://cdn.streamable.com/video/mp4/f5/f55ocn.mp4" type="video/mp4">
        TarayÄ±cÄ±n video etiketini desteklemiyor.
      </video>
      <div class="about-content">
        <h2>HakkÄ±mda</h2>
        <p>Merhaba, ben Ata GÃ¶Ã§ke, yani bilinen adÄ±yla WoozieDev. yazÄ±lÄ±m ve teknoloji benim asÄ±l tutkum. Kendi e-spor takÄ±mÄ± olan B2G/DEV E-Sportsâ€™u kurdum ve takÄ±m yÃ¶netimiyle aktif olarak ilgileniyorum.</p>
        <p>OyunlarÄ± Ã§ok severim; bu ik alanÄ± bir araya getiren projeler Ã¼zerinde Ã§alÄ±ÅŸmayÄ± Ã§ok seviyorum. Kod yazmak benim iÃ§in sadece iÅŸ deÄŸil, aynÄ± zamanda keyif aldÄ±ÄŸÄ±m bir sanat.</p>
      </div>
    </section>

    <!-- AUTH row (original position) -->
    <section id="auth">
      <h2>Ãœyelik Sistemi</h2>
      <div id="authRow">
        <div id="registerBox">
          <h3>KayÄ±t Ol</h3>
          <input id="regUsername" type="text" placeholder="KullanÄ±cÄ± adÄ± (eÅŸsiz & temiz)"><br>
          <input id="regEmail" type="email" placeholder="E-mail"><br>
          <input id="regPassword" type="password" placeholder="Åžifre"><br>
          <button onclick="register()">KayÄ±t Ol</button>
        </div>

        <div id="loginBox">
          <h3>GiriÅŸ Yap</h3>
          <input id="loginEmail" type="email" placeholder="E-mail"><br>
          <input id="loginPassword" type="password" placeholder="Åžifre"><br>
          <button onclick="login()">GiriÅŸ</button>
          <button onclick="resetPassword()" style="background:#333;color:#fff;margin-left:8px">Åžifremi Unuttum</button>
        </div>
      </div>

      <div id="userBox" style="display:none;margin-top:10px">
        <p>HoÅŸgeldin, <span id="userEmail"></span> (<span id="userName"></span>)</p>
        <button onclick="logout()">Ã‡Ä±kÄ±ÅŸ Yap</button>
      </div>
    </section>

    <!-- Interactive area (chat, dm) -->
    <section id="interactiveArea">
      <div class="chat-layout">
        <div class="chat-box">
          <h3>Genel Sohbet</h3>
          <div id="globalChat"></div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <input id="globalMsg" placeholder="Mesaj yaz..." class="input" />
            <button onclick="sendGlobalMsg()">GÃ¶nder</button>
          </div>
        </div>

        <div style="width:48%">
          <div class="chat-box">
            <h3>DM / KullanÄ±cÄ± Ara</h3>
            <input id="searchUserInput" class="input" placeholder="KullanÄ±cÄ± adÄ± veya e-mail ara" oninput="searchUsersDebounced()" />
            <ul id="searchResults" style="margin:8px 0;padding:0;max-height:140px;overflow:auto"></ul>
          </div>
          <div class="chat-box" style="margin-top:12px">
            <h3>DM: <span id="dmWith">â€”</span></h3>
            <div id="dmBox"></div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <input id="dmMsg" class="input" placeholder="Ã–zel mesaj..." />
              <button onclick="sendDM()">GÃ¶nder</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- public profile view -->
    <section id="profileViewPanel" style="display:none;margin-top:20px;text-align:left">
      <div class="profile-card" id="profileCardPublic">
        <img id="profilePublicImg" src="https://via.placeholder.com/96" alt="profil">
        <h3 id="profilePublicUsername">KullanÄ±cÄ±</h3>
        <p id="profilePublicAbout"></p>
        <p>Instagram: <span id="profilePublicInstagram"></span></p>
        <p>TikTok: <span id="profilePublicTiktok"></span></p>
      </div>
    </section>

    <!-- contact (original) -->
    <section id="contact">
      <h2>Ä°letiÅŸim</h2>
      <p>Sosyal Medya Ãœzerinden Bize UlaÅŸabilirsiniz:</p>
      <div class="socials">
        <a href="https://instagram.com/wooziedev" target="_blank">Instagram</a>
        <a href="https://twitter.com/wooziedev" target="_blank">Twitter</a>
        <a href="https://www.tiktok.com/@wooziedev" target="_blank">TikTok</a>
      </div>
      <p>E-posta: <a href="mailto:nexuforge@hotmail.com" style="color:#fff">nexuforge@hotmail.com</a></p>
    </section>

  </main>

  <footer>&copy; 2025 NexuForge TÃ¼m HaklarÄ± Gizlidir. </footer>

  <!-- SIDEBAR (menu) -->
  <div id="sidebar" class="sidebar" aria-hidden="true">
    <div style="display:flex;justify-content:flex-end">
      <span class="closeX" onclick="toggleSidebar()">âœ•</span>
    </div>
    <h3>MenÃ¼</h3>

    <!-- profile & settings only visible when logged in -->
    <div id="menuLogged" style="display:none">
      <div class="menu-item" onclick="openPanelAndCloseSidebar('profile')">Profilim</div>
      <div class="menu-item" onclick="openPanelAndCloseSidebar('settings')">Ayarlar</div>
      <div class="menu-item" onclick="openPanelAndCloseSidebar('products')">ÃœrÃ¼nler</div>
      <div class="menu-item" onclick="openPanelAndCloseSidebar('scrim')">Scrim / Eventler</div>
    </div>

    <!-- public -->
    <div id="menuPublic">
      <div class="menu-item" onclick="openPanelAndCloseSidebar('products')">ÃœrÃ¼nler</div>
      <div class="menu-item" onclick="openPanelAndCloseSidebar('feedback')">Geri Bildirim</div>
      <div class="menu-item" onclick="openPanelAndCloseSidebar('about')">HakkÄ±mÄ±zda</div>
    </div>

    <hr style="border-color:#222;margin:12px 0">

    <div id="panel-profile" class="panel">
      <h3>Profil AyarlarÄ±</h3>
      <div class="profile-card">
        <img id="myProfileImg" src="https://via.placeholder.com/96" alt="profil">
        <input id="profileImageInput" type="file" accept="image/*" class="input">
        <input id="profileAbout" class="input" placeholder="HakkÄ±mda">
        <input id="profileInstagram" class="input" placeholder="Instagram kullanÄ±cÄ± adÄ±">
        <input id="profileTiktok" class="input" placeholder="TikTok kullanÄ±cÄ± adÄ±">
        <input id="changeUsernameInput" class="input" placeholder="Yeni kullanÄ±cÄ± adÄ± (ÅŸifre ile onayla)">
        <input id="confirmPwdForUserChange" type="password" class="input" placeholder="Mevcut ÅŸifreniz">
        <button onclick="saveMyProfile()">Kaydet</button>
      </div>
    </div>

    <div id="panel-settings" class="panel">
      <h3>Ayarlar</h3>
      <button onclick="resendVerification()">DoÄŸrulama Maili Yeniden GÃ¶nder</button>
      <div style="margin-top:12px">
        <input id="pwdResetEmail" class="input" placeholder="Åžifre sÄ±fÄ±rlama e-mail" />
        <button onclick="sendPasswordReset()">Åžifre Yenile</button>
      </div>
      <div style="margin-top:12px">
        <h4>Bildirim AyarlarÄ±</h4>
        <label><input id="toggleSound" type="checkbox"> Mesaj sesi</label>
      </div>
    </div>

    <div id="panel-products" class="panel">
      <h3>ÃœrÃ¼nler</h3>
      <div id="productList"></div>
      <div style="margin-top:8px;color:#aaa">(ÃœrÃ¼n ekleme/stok ayarÄ± admin panelinden yapÄ±lÄ±r)</div>
    </div>

    <div id="panel-scrim" class="panel">
      <h3>Scrim / Eventler</h3>
      <div id="scrimList"></div>
      <div style="margin-top:8px;color:#aaa">(Organizasyonlar admin panelinden yÃ¶netilir)</div>
    </div>

    <div id="panel-feedback" class="panel">
      <h3>Geri Bildirim</h3>
      <textarea id="feedbackText" class="input" rows="4" placeholder="Geri bildiriminizi yazÄ±n..."></textarea>
      <button onclick="sendFeedback()">GÃ¶nder</button>
      <div id="feedbackStatus" style="margin-top:8px;color:#0f0"></div>
    </div>

    <div id="panel-notifs" class="panel">
      <h3>Bildirimler</h3>
      <div id="notifList"></div>
    </div>

    <hr style="border-color:#222;margin:14px 0">

    <div style="margin-top:10px">
      <div style="display:flex;gap:8px;align-items:center">
        <button onclick="openAdminModal()">Admin GiriÅŸi</button>
        <button id="adminPanelBtn" style="display:none" onclick="openPanelAndCloseSidebar('admin')">Admin Panel</button>
      </div>
    </div>

    <div id="panel-admin" class="panel">
      <h3>Admin Panel</h3>
      <div style="display:flex;gap:8px">
        <div style="flex:1">
          <h4>KullanÄ±cÄ±lar</h4>
          <div id="adminUsersList" style="max-height:180px;overflow:auto"></div>
        </div>
        <div style="flex:1">
          <h4>Geri Bildirimler</h4>
          <div id="adminFeedbackList" style="max-height:180px;overflow:auto"></div>
        </div>
      </div>
      <div style="margin-top:12px">
        <h4>ÃœrÃ¼n Ekle</h4>
        <input id="productName" class="input" placeholder="ÃœrÃ¼n adÄ±">
        <input id="productStock" class="input" placeholder="Stok (adet)">
        <input id="productPrice" class="input" placeholder="Fiyat (TL)">
        <button onclick="adminAddProduct()">Ekle</button>
      </div>
      <div style="margin-top:12px">
        <h4>Scrim / Event Ekle</h4>
        <input id="eventName" class="input" placeholder="Etkinlik adÄ±">
        <input id="eventDate" class="input" placeholder="Tarih / saat">
        <button onclick="adminAddEvent()">Ekle</button>
      </div>
      <div style="margin-top:12px">
        <h4>Sistem Bildirimi GÃ¶nder</h4>
        <input id="notifTitle" class="input" placeholder="BaÅŸlÄ±k">
        <textarea id="notifBody" class="input" rows="3" placeholder="Ä°leti"></textarea>
        <button onclick="adminSendNotif()">GÃ¶nder</button>
      </div>
    </div>

  </div>

  <!-- Admin modal -->
  <div id="adminModal">
    <div class="box">
      <h3>Admin GiriÅŸi</h3>
      <input id="adminUser" class="input" placeholder="Admin kullanÄ±cÄ± adÄ±">
      <input id="adminPass" type="password" class="input" placeholder="Admin ÅŸifre">
      <div style="display:flex;gap:8px;margin-top:8px">
        <button onclick="adminLogin()">GiriÅŸ Yap</button>
        <button onclick="closeAdminModal()">Kapat</button>
      </div>
      <div id="adminMsg" style="margin-top:8px;color:#f88"></div>
    </div>
  </div>

<script>
/* ================== DEMO BACKEND using localStorage (replace with Firebase later) ================== */

/* Utility: localStorage arrays */
function _get(key){ try{ return JSON.parse(localStorage.getItem(key)) || []; }catch(e){ return []; } }
function _set(key,val){ localStorage.setItem(key, JSON.stringify(val)); }

/* Seed admin user into "users" (if not exist) */
(function seed(){
  const users = _get('users');
  if(!users.find(u=>u.username==='wooziedev')){
    users.push({
      uid: 'admin-uid',
      username: 'wooziedev',
      email: 'admin@local',
      password: 'Ati1234', // demo only
      about: 'Site sahibi admin.',
      profileImg: '',
      instagram:'wooziedev',
      tiktok:'wooziedev',
      friends: []
    });
    _set('users', users);
  }
  // products, events, notifs init
  if(!localStorage.getItem('products')) _set('products', []);
  if(!localStorage.getItem('events')) _set('events', []);
  if(!localStorage.getItem('notifications')) _set('notifications', []);
  if(!localStorage.getItem('globalChat')) _set('globalChat', []);
  if(!localStorage.getItem('feedback')) _set('feedback', []);
  if(!localStorage.getItem('dms')) localStorage.setItem('dms', JSON.stringify({})); // object of dmid->messages
})();

/* Globals */
let currentUser = null;
let currentDMWith = null;

/* banned words */
const bannedWords = ["amk","aq","piÃ§","orospu","sikerim","gÃ¶t","yarak","sÃ¼rtÃ¼k","pedofil","sapÄ±k","sapkÄ±n"];

/* ----------------- UI helpers ----------------- */
function toggleSidebar(){
  document.getElementById('sidebar').classList.toggle('open');
}
function closeSidebar(){ document.getElementById('sidebar').classList.remove('open'); }
function openPanelAndCloseSidebar(panelName){
  closeSidebar();
  // hide all main panels
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  // map name -> panel id(s)
  if(panelName === 'profile') document.getElementById('panel-profile').classList.add('active');
  if(panelName === 'settings') document.getElementById('panel-settings').classList.add('active');
  if(panelName === 'products') document.getElementById('panel-products').classList.add('active');
  if(panelName === 'scrim') document.getElementById('panel-scrim').classList.add('active');
  if(panelName === 'feedback') document.getElementById('panel-feedback').classList.add('active');
  if(panelName === 'notifs') document.getElementById('panel-notifs').classList.add('active');
  if(panelName === 'admin') document.getElementById('panel-admin').classList.add('active');
  // scroll to top of main
  window.scrollTo({top:110, behavior:'smooth'});
}

/* ----------------- Auth: register / login / logout ----------------- */
function register(){
  const username = document.getElementById('regUsername').value.trim();
  const email = document.getElementById('regEmail').value.trim();
  const password = document.getElementById('regPassword').value;
  if(!username || !email || !password) return alert('TÃ¼m alanlarÄ± doldurun.');
  const low = username.toLowerCase();
  if(bannedWords.some(w=>low.includes(w))) return alert('KullanÄ±cÄ± adÄ± uygun deÄŸil (argo).');

  const users = _get('users');
  if(users.find(u=>u.username.toLowerCase()===username.toLowerCase())) return alert('Bu kullanÄ±cÄ± adÄ± alÄ±nmÄ±ÅŸ.');
  if(users.find(u=>u.email.toLowerCase()===email.toLowerCase())) return alert('Bu e-mail zaten kullanÄ±lmÄ±ÅŸ.');

  const uid = 'u'+Date.now();
  users.push({ uid, username, email, password, about:'', profileImg:'', instagram:'', tiktok:'', friends:[] });
  _set('users', users);

  alert('KayÄ±t baÅŸarÄ±lÄ±! Åžimdi giriÅŸ yapabilirsiniz.');
  // auto-fill login
  document.getElementById('loginEmail').value = email;
}
window.register = register;

function login(){
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;
  const users = _get('users');
  const user = users.find(u=>u.email.toLowerCase()===email.toLowerCase() && u.password===password);
  if(!user) return alert('E-mail veya ÅŸifre yanlÄ±ÅŸ.');
  // set current session (sessionStorage)
  sessionStorage.setItem('currentUser', JSON.stringify(user));
  currentUser = user;
  refreshUIOnAuth();
}
window.login = login;

function logout(){
  sessionStorage.removeItem('currentUser');
  currentUser = null;
  // hide interactive area
  document.getElementById('interactiveArea').style.display = 'none';
  document.getElementById('userBox').style.display = 'none';
  document.getElementById('menuLogged').style.display = 'none';
  document.getElementById('menuLogout').style.display = 'none';
  document.getElementById('adminPanelBtn').style.display = 'none';
  // stop listeners are implicit in demo (no persistent listeners)
  alert('Ã‡Ä±kÄ±ÅŸ yapÄ±ldÄ±.');
}
window.logout = logout;

function refreshUIOnAuth(){
  const cur = JSON.parse(sessionStorage.getItem('currentUser') || 'null');
  if(cur){
    currentUser = cur;
    document.getElementById('userBox').style.display = 'block';
    document.getElementById('registerBox').style.display = 'none';
    document.getElementById('loginBox').style.display = 'none';
    document.getElementById('userEmail').textContent = currentUser.email;
    document.getElementById('userName').textContent = currentUser.username;
    document.getElementById('menuLogged').style.display = 'block';
    document.getElementById('menuLogout').style.display = 'block';
    document.getElementById('interactiveArea').style.display = 'block';
    // load profile image if exists
    document.getElementById('myProfileImg').src = currentUser.profileImg || 'https://via.placeholder.com/96';
    // load profile data into panel
    fillProfilePanel();
    // load products/events/notifications
    renderProducts();
    renderEvents();
    renderNotifications();
    listenGlobalChat(); // enable chat listening using storage event
  } else {
    document.getElementById('registerBox').style.display = 'block';
    document.getElementById('loginBox').style.display = 'block';
  }
}

/* If session exists on load */
document.addEventListener('DOMContentLoaded', ()=>{
  const cur = JSON.parse(sessionStorage.getItem('currentUser') || 'null');
  if(cur){ currentUser = cur; refreshUIOnAuth(); }
});

/* ----------------- Profile save (image stored as base64 in localStorage for demo) ----------------- */
async function saveMyProfile(){
  if(!currentUser) return alert('GiriÅŸ yapÄ±n.');
  const about = document.getElementById('profileAbout').value;
  const instagram = document.getElementById('profileInstagram').value.trim();
  const tiktok = document.getElementById('profileTiktok').value.trim();
  const newUsername = document.getElementById('changeUsernameInput').value.trim();
  const pwd = document.getElementById('confirmPwdForUserChange').value;

  // change username requires password
  if(newUsername){
    if(!pwd) return alert('Åžifre girin.');
    if(pwd !== currentUser.password) return alert('Åžifre yanlÄ±ÅŸ.');
    if(bannedWords.some(w => newUsername.toLowerCase().includes(w))) return alert('Yeni kullanÄ±cÄ± adÄ± uygun deÄŸil.');
    const users = _get('users');
    if(users.find(u=>u.username.toLowerCase()===newUsername.toLowerCase())) return alert('Bu kullanÄ±cÄ± adÄ± alÄ±nmÄ±ÅŸ.');
    // update in users array
    users.forEach(u=>{ if(u.uid===currentUser.uid) u.username = newUsername; });
    _set('users', users);
    currentUser.username = newUsername;
  }

  // image
  const file = document.getElementById('profileImageInput').files[0];
  if(file){
    const reader = new FileReader();
    reader.onload = function(e){
      const base64 = e.target.result;
      const users = _get('users');
      users.forEach(u=>{ if(u.uid===currentUser.uid) { u.profileImg = base64; u.about = about; u.instagram=instagram; u.tiktok=tiktok; }});
      _set('users', users);
      currentUser = users.find(u=>u.uid===currentUser.uid);
      sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
      document.getElementById('myProfileImg').src = base64;
      alert('Profil gÃ¼ncellendi (resim dahil).');
    };
    reader.readAsDataURL(file);
  } else {
    const users = _get('users');
    users.forEach(u=>{ if(u.uid===currentUser.uid) { u.about = about; u.instagram=instagram; u.tiktok=tiktok; }});
    _set('users', users);
    currentUser = users.find(u=>u.uid===currentUser.uid);
    sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
    alert('Profil gÃ¼ncellendi.');
  }

  // clear inputs
  document.getElementById('changeUsernameInput').value='';
  document.getElementById('confirmPwdForUserChange').value='';
}

/* fill profile panel inputs */
function fillProfilePanel(){
  if(!currentUser) return;
  document.getElementById('myProfileImg').src = currentUser.profileImg || 'https://via.placeholder.com/96';
  document.getElementById('profileAbout').value = currentUser.about || '';
  document.getElementById('profileInstagram').value = currentUser.instagram || '';
  document.getElementById('profileTiktok').value = currentUser.tiktok || '';
}

/* ----------------- Global chat: store in localStorage and use storage event to sync across tabs ----------------- */
function listenGlobalChat(){
  renderGlobalChat(); // initial
  // storage event will trigger renderGlobalChat in other tabs
  window.addEventListener('storage', (e)=>{
    if(e.key === 'globalChat') renderGlobalChat();
  });
}
function renderGlobalChat(){
  const msgs = _get('globalChat');
  const c = document.getElementById('globalChat');
  c.innerHTML = '';
  msgs.forEach(m=>{
    const d = document.createElement('div');
    d.className = 'msg';
    const time = m.createdAt ? new Date(m.createdAt).toLocaleString() : '';
    d.innerHTML = `<strong>${escapeHtml(m.senderName)}</strong> <small style="color:#aaa">(${time})</small><div>${escapeHtml(m.text)}</div>`;
    c.appendChild(d);
  });
  c.scrollTop = c.scrollHeight;
}
async function sendGlobalMsg(){
  if(!currentUser) return alert('GiriÅŸ yapÄ±n.');
  const text = document.getElementById('globalMsg').value.trim();
  if(!text) return;
  const msgs = _get('globalChat');
  msgs.push({ senderUid: currentUser.uid, senderEmail: currentUser.email, senderName: currentUser.username, text, createdAt: Date.now() });
  _set('globalChat', msgs);
  document.getElementById('globalMsg').value='';
  renderGlobalChat();
}
/* ----------------- Users search & DM ----------------- */
let searchTimeout = null;
function searchUsersDebounced(){ if(searchTimeout) clearTimeout(searchTimeout); searchTimeout = setTimeout(searchUsers, 300); }
function searchUsers(){
  const qv = document.getElementById('searchUserInput').value.trim().toLowerCase();
  const ul = document.getElementById('searchResults'); ul.innerHTML='';
  if(!qv) return;
  const users = _get('users').filter(u => (u.username && u.username.toLowerCase().includes(qv)) || (u.email && u.email.toLowerCase().includes(qv)));
  users.forEach(u=>{
    const li = document.createElement('li');
    li.textContent = `${u.username} â€” ${u.email}`;
    li.onclick = ()=>{ openDMWith(u.uid, u.username); };
    ul.appendChild(li);
  });
}
function dmDocId(a,b){ return (a<b)? a+'_'+b : b+'_'+a; }
function openDMWith(uid, displayName){
  if(!currentUser) return alert('GiriÅŸ yapÄ±n.');
  if(uid === currentUser.uid) return alert('Kendinle DM olmaz.');
  currentDMWith = uid;
  document.getElementById('dmWith').textContent = displayName;
  renderDM();
}
function renderDM(){
  const box = document.getElementById('dmBox'); box.innerHTML='';
  if(!currentDMWith) return;
  const dms = JSON.parse(localStorage.getItem('dms') || '{}');
  const id = dmDocId(currentUser.uid, currentDMWith);
  const msgs = dms[id] || [];
  msgs.forEach(m=>{
    const d = document.createElement('div'); d.className='msg';
    d.innerHTML = `<strong>${escapeHtml(m.fromName)}</strong> <small style="color:#aaa">${new Date(m.createdAt).toLocaleString()}</small><div>${escapeHtml(m.text)}</div>`;
    box.appendChild(d);
  });
  box.scrollTop = box.scrollHeight;
}
function sendDM(){
  if(!currentUser) return alert('GiriÅŸ yapÄ±n.');
  if(!currentDMWith) return alert('Bir kullanÄ±cÄ± seÃ§in.');
  const txt = document.getElementById('dmMsg').value.trim(); if(!txt) return;
  const dms = JSON.parse(localStorage.getItem('dms') || '{}');
  const id = dmDocId(currentUser.uid, currentDMWith);
  if(!dms[id]) dms[id]=[];
  dms[id].push({ fromUid: currentUser.uid, fromName: currentUser.username, text: txt, createdAt: Date.now() });
  localStorage.setItem('dms', JSON.stringify(dms));
  document.getElementById('dmMsg').value='';
  renderDM();
  // trigger storage event for other tabs:
  localStorage.setItem('dms_last_update', Date.now());
}
/* listen to dm updates across tabs */
window.addEventListener('storage',(e)=>{
  if(e.key === 'dms' || e.key === 'dms_last_update'){
    if(currentDMWith) renderDM();
  }
});

/* ----------------- Profile public view ----------------- */
async function viewProfileByUid(uid){
  const users = _get('users');
  const u = users.find(x=>x.uid===uid);
  if(!u) return alert('KullanÄ±cÄ± bulunamadÄ±');
  document.getElementById('profilePublicImg').src = u.profileImg || 'https://via.placeholder.com/96';
  document.getElementById('profilePublicUsername').textContent = u.username;
  document.getElementById('profilePublicAbout').textContent = u.about || '';
  document.getElementById('profilePublicInstagram').textContent = u.instagram || '-';
  document.getElementById('profilePublicTiktok').textContent = u.tiktok || '-';
  document.getElementById('profileViewPanel').style.display = 'block';
  window.scrollTo({top:500, behavior:'smooth'});
}
window.viewProfileByUid = viewProfileByUid;

/* ----------------- Feedback ----------------- */
async function sendFeedback(){
  const text = document.getElementById('feedbackText').value.trim();
  if(!text) return alert('Geri bildirim girin.');
  const arr = _get('feedback');
  arr.push({ id:'f'+Date.now(), from: currentUser? currentUser.uid : null, email: currentUser? currentUser.email : null, text, createdAt: Date.now() });
  _set('feedback', arr);
  document.getElementById('feedbackStatus').textContent = 'TeÅŸekkÃ¼rler! MesajÄ±nÄ±z iletildi.';
  document.getElementById('feedbackText').value='';
  renderAdminFeedback(); // update admin view if open
}

/* ----------------- Products & Events (render) ----------------- */
function renderProducts(){
  const p = _get('products');
  const out = document.getElementById('productList');
  out.innerHTML = p.length ? p.map(item=>`<div style="padding:8px;border-bottom:1px solid #222"><strong>${escapeHtml(item.name)}</strong><div>Fiyat: ${item.price} TL â€¢ Stok: ${item.stock}</div></div>`).join('') : '<div style="color:#aaa">ÃœrÃ¼n yok.</div>';
}
function renderEvents(){
  const e = _get('events');
  const out = document.getElementById('scrimList');
  out.innerHTML = e.length ? e.map(ev=>`<div style="padding:8px;border-bottom:1px solid #222"><strong>${escapeHtml(ev.name)}</strong><div>${escapeHtml(ev.date)}</div><div>Kazanan: ${escapeHtml(ev.winner||'-')}</div></div>`).join('') : '<div style="color:#aaa">Etkinlik yok.</div>';
}

/* ----------------- Notifications ----------------- */
function renderNotifications(){
  const n = _get('notifications');
  document.getElementById('notifList').innerHTML = n.map(x=>`<div style="padding:8px;border-bottom:1px solid #222"><strong>${escapeHtml(x.title)}</strong><div style="color:#ccc">${escapeHtml(x.body)}</div><small style="color:#777">${new Date(x.createdAt).toLocaleString()}</small></div>`).join('');
  const cnt = n.length;
  const el = document.getElementById('notifCount');
  if(cnt>0){ el.style.display='inline-block'; el.textContent = cnt; } else el.style.display='none';
}

/* ----------------- Admin features (demo auth) ----------------- */
function openAdminModal(){ document.getElementById('adminModal').style.display = 'flex'; document.getElementById('adminMsg').textContent=''; }
function closeAdminModal(){ document.getElementById('adminModal').style.display = 'none'; }
function adminLogin(){
  const u = document.getElementById('adminUser').value.trim();
  const p = document.getElementById('adminPass').value;
  // DEMO CHECK (THIS IS INSECURE, for demo only)
  if(u === 'wooziedev' && p === 'Ati1234'){
    localStorage.setItem('isAdmin', '1');
    document.getElementById('adminPanelBtn').style.display = 'inline-block';
    closeAdminModal();
    openPanelAndCloseSidebar('admin');
    renderAdminUsers(); renderAdminFeedback();
    alert('Admin giriÅŸi baÅŸarÄ±lÄ±.');
  } else {
    document.getElementById('adminMsg').textContent = 'HatalÄ± admin bilgileri';
  }
}

function renderAdminUsers(){
  const users = _get('users');
  const el = document.getElementById('adminUsersList');
  el.innerHTML = users.map(u=>`<div style="padding:6px;border-bottom:1px solid #222"><strong>${escapeHtml(u.username)}</strong><div style="color:#aaa">${escapeHtml(u.email)}</div><button onclick="viewProfileByUid('${u.uid}')">Profil</button></div>`).join('');
}
function renderAdminFeedback(){
  const fb = _get('feedback');
  const el = document.getElementById('adminFeedbackList');
  el.innerHTML = fb.map(f=>`<div style="padding:6px;border-bottom:1px solid #222"><div>${escapeHtml(f.text)}</div><small style="color:#777">${new Date(f.createdAt).toLocaleString()}</small></div>`).join('');
}

/* admin add product/event/notif */
function adminAddProduct(){
  const name = document.getElementById('productName').value.trim();
  const stock = Number(document.getElementById('productStock').value) || 0;
  const price = Number(document.getElementById('productPrice').value) || 0;
  if(!name) return alert('ÃœrÃ¼n adÄ± girin');
  const p = _get('products'); p.push({ id:'p'+Date.now(), name, stock, price }); _set('products', p);
  renderProducts();
  document.getElementById('productName').value=''; document.getElementById('productStock').value=''; document.getElementById('productPrice').value='';
  alert('ÃœrÃ¼n eklendi (demo).');
}
function adminAddEvent(){
  const name = document.getElementById('eventName').value.trim();
  const date = document.getElementById('eventDate').value.trim();
  if(!name) return alert('Etkinlik adÄ± girin');
  const e = _get('events'); e.push({ id:'e'+Date.now(), name, date, winner:null }); _set('events', e);
  renderEvents();
  document.getElementById('eventName').value=''; document.getElementById('eventDate').value='';
  alert('Event eklendi');
}
function adminSendNotif(){
  const title = document.getElementById('notifTitle').value.trim();
  const body = document.getElementById('notifBody').value.trim();
  if(!title || !body) return alert('BaÅŸlÄ±k ve ileti girin');
  const n = _get('notifications'); n.unshift({ id:'n'+Date.now(), title, body, createdAt: Date.now(), to:'all' }); _set('notifications', n);
  renderNotifications();
  document.getElementById('notifTitle').value=''; document.getElementById('notifBody').value='';
  alert('Bildirim gÃ¶nderildi');
}

/* render admin lists on open */
function renderAdminFeedback(){ const fb=_get('feedback'); document.getElementById('adminFeedbackList').innerHTML = fb.map(f=>`<div style="padding:6px;border-bottom:1px solid #222">${escapeHtml(f.text)}</div>`).join('') }
function renderAdminUsers(){ const u=_get('users'); document.getElementById('adminUsersList').innerHTML = u.map(x=>`<div style="padding:6px;border-bottom:1px solid #222"><strong>${escapeHtml(x.username)}</strong><div style="color:#aaa">${escapeHtml(x.email)}</div></div>`).join('') }

/* ----------------- Settings helpers ----------------- */
function resendVerification(){ alert('Demo: DoÄŸrulama maili gÃ¶nderme Firebase ile baÄŸlandÄ±ÄŸÄ±nda Ã§alÄ±ÅŸacak.'); }
function sendPasswordReset(){ const em = document.getElementById('pwdResetEmail').value.trim(); if(!em) return alert('Email girin'); alert('Demo: ÅŸifre sÄ±fÄ±rlama maili gÃ¶nderme Firebase ile baÄŸlandÄ±ÄŸÄ±nda Ã§alÄ±ÅŸacak.'); }

/* ----------------- Utility ----------------- */
function escapeHtml(unsafe){ if(unsafe===undefined || unsafe===null) return ''; return String(unsafe).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;') }
</script>
</body>
</html>
